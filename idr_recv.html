<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />




<link rel="stylesheet" href="style.css" type="text/css" />



<!--SyntaxHighlighter-->
<script type="text/javascript" src="scripts/shCore.js"></script>
<script type="text/javascript" src="scripts/shBrushPython.js"></script>
<script type="text/javascript" src="scripts/shBrushJScript.js"></script>
<link type="text/css" rel="stylesheet" href="styles/shCoreFadeToGrey.css"/>
<script type="text/javascript">SyntaxHighlighter.all();</script>

</head>


<body>
<div id="wrapper">

<div id="header">
    <p class="header_titleline">xy的分享空间</p>
    <p class="header_subline"><a href="/index.html">首页</a></p>
</div>


 <!--if(title)-->

<p>目录:</p>
<div id="TOC">
<ul>
<li><a href="#红外知识学习">红外知识学习</a></li>
<li><a href="#stm32接收红外信号">STM32接收红外信号</a><ul>
<li><a href="#stm32-使用stm32cube接收红外遥控信号">stm32 使用stm32cube接收红外遥控信号</a><ul>
<li><a href="#ping-out设置">ping out设置：</a></li>
<li><a href="#configuration">configuration</a></li>
</ul></li>
<li><a href="#使用keil调用函数接收代码">使用keil调用函数接收代码：</a></li>
</ul></li>
</ul>
</div>
 <!--if(toc)-->

<p>NEC格式红外遥控信号接收</p>
<p>本人工作中之后要用到红外遥控，虽然硬件中集成了红外接收知识，但是出于学习目的，编程接收红外信号。</p>
<h1 id="红外知识学习">红外知识学习</h1>
<p>在接收红外信号前，首先要了解红外信号的调试方式，为编程接收红外信号作准备。</p>
<p>参考：</p>
<p><a href="https://blog.csdn.net/flyingcys/article/details/78922588">红外遥控接收发射原理及ESP8266实现</a></p>
<h1 id="stm32接收红外信号">STM32接收红外信号</h1>
<p>本人手里刚好有stm32单片机，stm32有丰富的资料，详细的资料，决定通过stm32编程接收红外信号</p>
<p>stm32单片机购买地址：</p>
<p><a href="https://item.taobao.com/item.htm?spm=a1z09.2.0.0.7a1c2e8dZz1QRz&amp;id=551927199155&amp;_u=k1v61smfab7">STM32F103C8T6小系统板 单片机 核心板 STM32初级入门学习开发板</a></p>
<p>红外地址：</p>
<p><a href="https://detail.tmall.com/item.htm?id=553467229979&amp;spm=a1z09.2.0.0.7a1c2e8dZz1QRz&amp;_u=k1v61smcde0">单片机 红外遥控模块+接收头HX1838+NEC编码红外 遥控器3件套</a></p>
<h2 id="stm32-使用stm32cube接收红外遥控信号">stm32 使用stm32cube接收红外遥控信号</h2>
<p>首先选型，我用的是STM32F103C8T6，我用的st link调试，所以SYS中选择“Serial Wire”（要不然下载后，无法再用st link下载，必需长按复位键）。</p>
<p>以下是使用stm32cube的设置</p>
<h3 id="ping-out设置">ping out设置：</h3>
<p>RCC设置，设置系统时钟为外置输入：</p>
<div class="figure">
<img src=".\img\stm32_rcc.png" alt="RCC设置" />
<p class="caption">RCC设置</p>
</div>
<p>系统设置，设置调试方式为st link：</p>
<div class="figure">
<img src=".\img\stm32_sys.png" alt="系统设置" />
<p class="caption">系统设置</p>
</div>
<p>TIM2设置，这个主要是通过计数方式获取下降延时间差：</p>
<div class="figure">
<img src=".\img\stm32_tim2.png" alt="TIM2设置" />
<p class="caption">TIM2设置</p>
</div>
<p>USART设置，这个是设置高度串口，输入输出调试信息：</p>
<div class="figure">
<img src=".\img\stm32_usart1.png" alt="USART设置" />
<p class="caption">USART设置</p>
</div>
<p>Clock Configuration:</p>
<p>时钟设置：</p>
<div class="figure">
<img src=".\img\stm32_clock.png" alt="时钟设置" />
<p class="caption">时钟设置</p>
</div>
<h3 id="configuration">configuration</h3>
<p>USART1设置，使用默认配置就可以</p>
<p>NVIC Configuration:</p>
<div class="figure">
<img src=".\img\stm32_nvic_configuration.png" alt="NVIC Configuration" />
<p class="caption">NVIC Configuration</p>
</div>
<p>tim2 config Tim2配置，分频7199,所以100us计数一次，捕获下降沿，测量两个下降沿的宽度 :</p>
<div class="figure">
<img src=".\img\stm32_tim2_config_param.png" alt="param setting" />
<p class="caption">param setting</p>
</div>
<div class="figure">
<img src=".\img\stm32_tim2_nvic_setting.png" alt="tim2 nvic setting" />
<p class="caption">tim2 nvic setting</p>
</div>
<p>以上stm32cute设置完成，可以生成代码。</p>
<h2 id="使用keil调用函数接收代码">使用keil调用函数接收代码：</h2>
<p>main.c中修改:</p>
<pre><code>/* USER CODE BEGIN PV */
/* Private variables ---------------------------------------------------------*/
/// 全局变量
uint8_t ir[4], flag, lianfa, xx;
/* USER CODE END PV */
...

/* USER CODE BEGIN 0 */
/// cat be use printf scanf
int fputc(int ch, FILE *f)
{
    HAL_UART_Transmit(&amp;huart1, (uint8_t *)&amp;ch,1, 0xFFFF);
    return ch;
}
int fgetc(FILE *f)
{
  uint8_t  ch;
    HAL_UART_Receive(&amp;huart1,(uint8_t *)&amp;ch, 1, 0xFFFF);
    return  ch;
}
/* USER CODE END 0 */

....
main函数中设置
  /* USER CODE BEGIN 2 */
    HAL_TIM_Base_Start_IT(&amp;htim2);
    if (HAL_TIM_IC_Start_IT(&amp;htim2, TIM_CHANNEL_2) != HAL_OK)
    {
        printf(&quot;IC Start it error\n&quot;);
        Error_Handler();
    }
  /* USER CODE END 2 */
  
  </code></pre>
<p>stm32f1xx_it.c</p>
<pre><code>/* USER CODE BEGIN 0 */
extern uint8_t ir[4], flag, lianfa, xx;
uint32_t count[33]; // user for debug
/* USER CODE END 0 */
...

//TIM2_IRQHandler中添加：
  /* USER CODE BEGIN TIM2_IRQn 0 */
    //printf(&quot;debug000:%#X, ccr2:%#x\n&quot;, TIM2-&gt;SR, TIM2-&gt;SR);
    if (4&amp;TIM2-&gt;SR)
    {
        uint32_t bu;
        //printf(&quot;=&gt;%d\n&quot;, TIM2-&gt;CCR2);
        bu = TIM2-&gt;CCR2;
        if(bu&lt;140&amp;bu&gt;128){xx = 0; count[xx]=bu;}
        else if(bu&gt;6&amp;bu&lt;15) {ir[xx/8]&gt;&gt;=1;xx++;count[xx]=bu;}
        else if(bu&gt;18&amp;bu&lt;25){ir[xx/8]&gt;&gt;=1; ir[xx/8]|=0x80;xx++;count[xx]=bu;}
        else if(bu&gt;108&amp;bu&lt;116)
        {
            printf(&quot;lianfa\n&quot;);
            lianfa=1;
        }
        if(xx==32)
        {
            int i;
            for(i=0; i&lt;33; i++)printf(&quot;%d\t&quot;, count[i]);
            printf(&quot;recv data:%x %x %x %x\n&quot;, ir[0], ir[1], ir[2], ir[3]);
            xx=0;
            flag=1;
        }
        TIM2-&gt;CNT = 0;
    }

  /* USER CODE END TIM2_IRQn 0 */</code></pre>

<div id="footer">
    <p class="footer_titleline">Human knowledge belongs to the world</p>
    <p class="footer_subline">Contact: xyyangkun@163.com</p>
    <p class="footer_subline">声明: 本站如有侵权行为请及时通知至以上邮箱</p>
</div>
</div> <!--wrapper-->
</body>
</html>
